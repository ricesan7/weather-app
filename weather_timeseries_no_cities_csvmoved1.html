<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Weather Timeseries</title>
<style>
*{box-sizing:border-box}
body{font-family:system-ui, sans-serif;margin:0}
header{position:sticky;top:0;background:#fff;padding:8px 12px;box-shadow:0 2px 4px rgba(0,0,0,.1);z-index:10}
h1{font-size:18px;margin:0}
main{padding:12px 16px;max-width:1000px;margin:auto}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
.controls label{display:flex;align-items:center;gap:4px}
.controls input,.controls select{padding:6px 8px;border:1px solid #ccc;border-radius:4px}
.controls button{padding:8px 12px;border:1px solid #888;border-radius:4px;background:#f9f9f9;cursor:pointer}
.controls button:hover{background:#f1f5f9}
.spacer{flex:1}
.legend{display:flex;gap:16px;align-items:center;margin:8px 0}
.chart-wrap{position:relative;background:#fff;border:1px solid #ddd;padding:12px;border-radius:8px}
canvas{width:100%!important;height:400px!important}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <h1>Weather Timeseries</h1>
</header>
<main>
  <div class="controls">
    <label>緯度 <input id="lat" type="number" step="0.0001" value="35.6812"></label>
    <label>経度 <input id="lon" type="number" step="0.0001" value="139.7671"></label>
    <button onclick="fetchWeather()">取得</button>
    <button onclick="downloadCSV()">CSVダウンロード</button>
  </div>

  <div class="legend">
    <label><input type="checkbox" id="showMax" checked> 最高気温</label>
    <label><input type="checkbox" id="showMin" checked> 最低気温</label>
  </div>

  <div class="chart-wrap">
    <canvas id="weatherChart"></canvas>
  </div>
</main>

<script>
let chart;
async function fetchWeather(){
  const lat=document.getElementById("lat").value;
  const lon=document.getElementById("lon").value;
  const url=`https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=2024-09-01&end_date=2025-09-01&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto`;
  const res=await fetch(url);
  const data=await res.json();

  const labels=data.daily.time;
  const tmax=data.daily.temperature_2m_max;
  const tmin=data.daily.temperature_2m_min;

  if(chart){chart.destroy();}
  const ctx=document.getElementById("weatherChart");
  chart=new Chart(ctx,{
    type:"line",
    data:{
      labels:labels,
      datasets:[
        {label:"最高気温",data:tmax,borderColor:"red",backgroundColor:"rgba(255,0,0,.2)",hidden:!document.getElementById("showMax").checked},
        {label:"最低気温",data:tmin,borderColor:"blue",backgroundColor:"rgba(0,0,255,.2)",hidden:!document.getElementById("showMin").checked}
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });
  chart._weatherData={labels,tmax,tmin};
}

function downloadCSV(){
  if(!chart||!chart._weatherData){alert("先にデータを取得してください");return;}
  const {labels,tmax,tmin}=chart._weatherData;
  let csv="日付,最高気温,最低気温\n";
  for(let i=0;i<labels.length;i++){
    csv+=`${labels[i]},${tmax[i]},${tmin[i]}\n`;
  }
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="weather.csv";a.click();
  URL.revokeObjectURL(url);
}

document.getElementById("showMax").addEventListener("change",()=>{if(chart)chart.getDatasetMeta(0).hidden=!event.target.checked;chart.update();});
document.getElementById("showMin").addEventListener("change",()=>{if(chart)chart.getDatasetMeta(1).hidden=!event.target.checked;chart.update();});
</script>
</body>
</html>

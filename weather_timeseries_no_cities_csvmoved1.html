<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Weather Timeseries</title>
<style>
*{box-sizing:border-box}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;margin:0;background:#f6f7fb;color:#222}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 16px;z-index:10}
h1{font-size:18px;margin:0}
main{padding:12px 16px;max-width:1000px;margin:0 auto}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
.controls label{display:flex;align-items:center;gap:4px}
.controls input,select{padding:6px 8px;border:1px solid #d1d5db;border-radius:8px;background:#fff;min-width:110px}
.controls button{padding:8px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;cursor:pointer}
.controls button:hover{background:#f1f5f9}
.spacer{flex:1}
.legend{display:flex;gap:16px;align-items:center;margin:4px 0 8px 0}
.chart-wrap{position:relative;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px 12px}
.ylabel{position:absolute;left:8px;top:8px;font-size:12px;color:#4b5563}
.card{display:flex;justify-content:space-between;gap:12px;align-items:center;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;margin-top:10px}
.card.hidden{display:none}
.note{margin-top:12px;color:#6b7280}
.gap{display:inline-block;width:24px}
#mapModal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
#mapCard{width:min(960px,95vw);height:min(75vh,760px);background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;flex-direction:column}
#mapHeader{padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:8px}
#map{flex:1}
#mapFooter{padding:8px 12px;border-top:1px solid #e5e7eb;display:flex;align-items:center;gap:12px;justify-content:space-between}
.badge{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px;font-size:12px}
.small{font-size:12px;color:#6b7280}
.coord-group{display:flex;gap:12px;align-items:center}
.coord-input{width:90px;min-width:0}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
<header><h1>Weather Timeseries</h1></header>
<main>
  <!-- ä¸Šæ®µï¼šç·¯åº¦çµŒåº¦ãƒ»é©ç”¨ãƒ»åœ°å›³ãƒ»ã‚¨ãƒªã‚¢åãƒ»ãŠæ°—ã«å…¥ã‚Š -->
  <section class="controls">
    <div class="coord-group">
      <label>ç·¯åº¦ <input id="lat" class="coord-input" type="number" step="0.0001" value="35.6812"></label>
      <label>çµŒåº¦ <input id="lon" class="coord-input" type="number" step="0.0001" value="139.7671"></label>
    </div>
    <button id="apply">é©ç”¨</button>
    <button id="mapBtn">ğŸ—ºï¸ åœ°å›³ã§é¸ã¶</button>
    <span class="badge" id="locBadge">ç¾åœ¨: 35.6812, 139.7671</span>
    <span class="badge" id="areaBadge">ã‚¨ãƒªã‚¢: å–å¾—ä¸­â€¦</span>
    <button id="favAdd">â˜† ãŠæ°—ã«å…¥ã‚Šä¿å­˜</button>
    <select id="favList"><option value="">ãŠæ°—ã«å…¥ã‚Šã‚’é¸æŠ</option></select>
    <button id="favDel" title="é¸æŠä¸­ã®ãŠæ°—ã«å…¥ã‚Šã‚’å‰Šé™¤">å‰Šé™¤</button>
    <div class="spacer"></div>
  </section>

  <!-- ä¸‹æ®µï¼šæœŸé–“é¸æŠï¼ˆæ–°ã—ãç›´è¿‘7æ—¥ãƒœã‚¿ãƒ³è¿½åŠ æ¸ˆã¿ï¼‰ -->
  <section class="controls">
    <button data-range="7">ç›´è¿‘7æ—¥</button>
    <button data-range="30">ç›´è¿‘30æ—¥</button>
    <button data-range="400">ç´„1å¹´</button>
    <button id="customRangeBtn">æœŸé–“æŒ‡å®š</button>
    <input id="start" type="date">
    <input id="end" type="date">
    <div class="spacer"></div>
    <button id="csvBtn">â¬‡ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <span class="small">â€» çµ‚äº†æ—¥ã¯å¸¸ã«ã€Œæ˜¨æ—¥ã€ã«ä¸¸ã‚ã¾ã™</span>
  </section>

  <section class="chart-wrap">
    <div class="ylabel">æ°—æ¸© (Â°C)</div>
    <canvas id="chart" height="320"></canvas>
  </section>

  <section id="selected-card" class="card hidden">
    <div><strong id="sel-date">â€”</strong></div>
    <div>
      <span>æœ€é«˜: <span id="sel-max">â€”</span> Â°C</span>
      <span class="gap"></span>
      <span>æœ€ä½: <span id="sel-min">â€”</span> Â°C</span>
    </div>
  </section>

  <section class="note">
    <small>ãƒ‡ãƒ¼ã‚¿: Open-Meteo (archive-api)ã€‚åœ°å›³ã‚¿ã‚¤ãƒ«: Carto / OSM HOTã€‚ã‚¨ãƒªã‚¢å: Nominatim (OpenStreetMap)ã€‚<br>
    *fileç›´é–‹ãã§ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚GitHub Pages ãªã©ã® https ã§é–‹ã„ã¦ãã ã•ã„ã€‚*</small>
  </section>
</main>

<!-- åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="mapModal">
  <div id="mapCard">
    <div id="mapHeader">
      <strong>ğŸ—ºï¸ æ—¥æœ¬åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ç·¯åº¦çµŒåº¦ã‚’ã‚»ãƒƒãƒˆ</strong>
      <span style="margin-left:auto"></span>
      <button id="closeMap">é–‰ã˜ã‚‹</button>
    </div>
    <div id="map"></div>
    <div id="mapFooter">
      <div style="display:flex;gap:8px;align-items:center">
        <span id="picked" class="badge">æœªé¸æŠ</span>
        <select id="tileSel">
          <option value="carto">Carto Lightï¼ˆæ¨å¥¨ï¼‰</option>
          <option value="voyager">Carto Voyager</option>
          <option value="hot">OSM Humanitarian</option>
        </select>
      </div>
      <button id="usePoint">ã“ã®åœ°ç‚¹ã‚’é©ç”¨</button>
    </div>
  </div>
</div>

<script>
const latEl=document.getElementById('lat'), lonEl=document.getElementById('lon');
const applyBtn=document.getElementById('apply'), chartCanvas=document.getElementById('chart');
const startEl=document.getElementById('start'), endEl=document.getElementById('end');
const customBtn=document.getElementById('customRangeBtn'), showMaxEl=document.getElementById('showMax'), showMinEl=document.getElementById('showMin');
const locBadge=document.getElementById('locBadge'), areaBadge=document.getElementById('areaBadge'), csvBtn=document.getElementById('csvBtn');
const favAddBtn=document.getElementById('favAdd'), favList=document.getElementById('favList'), favDel=document.getElementById('favDel');
const selCard=document.getElementById('selected-card'), selDate=document.getElementById('sel-date'), selMax=document.getElementById('sel-max'), selMin=document.getElementById('sel-min');

function updateLocBadge(){ locBadge.textContent = `ç¾åœ¨: ${Number(latEl.value).toFixed(4)}, ${Number(lonEl.value).toFixed(4)}`; }
function fmt(d){ const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
function yesterday(){ const d=new Date(); d.setDate(d.getDate()-1); d.setHours(0,0,0,0); return d; }

function wmoToJa(code){
  const c=Number(code);
  if([0].includes(c))return'æ™´ã‚Œ';
  if([1].includes(c))return'æ™´ã‚Œæ™‚ã€…æ›‡ã‚Š';
  if([2].includes(c))return'æ™´ã‚Œä¸€æ™‚æ›‡ã‚Š';
  if([3].includes(c))return'æ›‡ã‚Š';
  if([45,48].includes(c))return'éœ§';
  if([51,53,55,56,57].includes(c))return'éœ§é›¨';
  if([61,63,65,80,81,82].includes(c))return'é›¨';
  if([66,67].includes(c))return'ã¿ãã‚Œ';
  if([71,73,75,85,86,77].includes(c))return'é›ª';
  if([95,96,99].includes(c))return'é›·é›¨';
  return'ä¸æ˜';
}

async function fetchArchive(lat,lon,start,end){
  const url=new URL('https://archive-api.open-meteo.com/v1/archive');
  url.searchParams.set('latitude',lat); url.searchParams.set('longitude',lon);
  url.searchParams.set('start_date',start); url.searchParams.set('end_date',end);
  url.searchParams.set('daily','temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode');
  url.searchParams.set('timezone','auto');
  const res=await fetch(url.toString());
  if(!res.ok) throw new Error('HTTP '+res.status);
  const j=await res.json(), t=j.daily||{};
  const dates=t.time||[], tmax=t.temperature_2m_max||[], tmin=t.temperature_2m_min||[], prec=t.precipitation_sum||[], wxc=t.weathercode||[];
  return dates.map((d,i)=>{ const code=wxc[i]??''; const label=(code===''||code===null||Number.isNaN(Number(code)))?'':wmoToJa(code);
    return {date:d,tmax:tmax[i]??'',tmin:tmin[i]??'',weather_code:code,weather_label:label,precipitation:prec[i]??''}; });
}

async function reverseGeocode(lat,lon){
  try{
    const url=new URL('https://nominatim.openstreetmap.org/reverse');
    url.searchParams.set('lat',lat); url.searchParams.set('lon',lon);
    url.searchParams.set('format','jsonv2'); url.searchParams.set('accept-language','ja');
    const res=await fetch(url.toString(),{headers:{'Referer':'https://example.local'}});
    if(!res.ok) throw new Error('RG '+res.status);
    const j=await res.json(), a=j.address||{};
    const name=a.city||a.town||a.village||a.municipality||a.county||a.state||j.display_name||'';
    return name||`${lat.toFixed(4)},${lon.toFixed(4)}`;
  }catch(e){ console.warn(e); return `${lat.toFixed(4)},${lon.toFixed(4)}`; }
}

let chart,lastRows=[];
function ensureChart(){
  if(chart) return chart;
  chart=new Chart(chartCanvas,{type:'line',
    data:{labels:[],datasets:[
      {label:'æœ€é«˜æ°—æ¸©',data:[],borderWidth:2,pointRadius:0,tension:0,borderColor:'#ef4444',yAxisID:'y'},
      {label:'æœ€ä½æ°—æ¸©',data:[],borderWidth:2,pointRadius:0,tension:0,borderColor:'#3b82f6',yAxisID:'y'}
    ]},
    options:{responsive:true,interaction:{mode:'nearest',intersect:false,axis:'x'},
      scales:{y:{title:{display:true,text:'Â°C'}}},
      plugins:{tooltip:{callbacks:{title:(c)=>c[0]?.label??'',label:(c)=>`${c.dataset.label}: ${c.parsed.y?.toFixed?.(1)??'â€”'} Â°C`}},
               legend:{onClick:(e,li)=>{const i=li.datasetIndex; const m=chart.getDatasetMeta(i); m.hidden=m.hidden===null?!chart.data.datasets[i].hidden:null; chart.update();}}},
      onClick:(evt)=>{const p=chart.getElementsAtEventForMode(evt,'nearest',{intersect:false},true)[0]; if(!p)return;
        const i=p.index; selDate.textContent=chart.data.labels[i]; selMax.textContent=(chart.data.datasets[0].data[i]??'â€”'); selMin.textContent=(chart.data.datasets[1].data[i]??'â€”'); selCard.classList.remove('hidden');}
    }});
  return chart;
}

async function loadRange(days){
  const lat=parseFloat(latEl.value), lon=parseFloat(lonEl.value);
  const end=yesterday(); const start=new Date(end.getTime()-(days*24*3600*1000));
  await loadCustom(fmt(start),fmt(end),lat,lon);
}
async function loadCustom(start,end,lat,lon){
  try{
    const y=yesterday(); let endD=new Date(end), startD=new Date(start);
    if(endD>y) endD=y; if(startD>endD){const t=startD; startD=endD; endD=t;}
    document.body.style.cursor='wait';
    const [rows,area]=await Promise.all([fetchArchive(lat,lon,fmt(startD),fmt(endD)), reverseGeocode(lat,lon)]);
    lastRows=rows.slice(); areaBadge.textContent=`ã‚¨ãƒªã‚¢: ${area}`;
    const c=ensureChart(); c.data.labels=rows.map(r=>r.date); c.data.datasets[0].data=rows.map(r=>r.tmax); c.data.datasets[1].data=rows.map(r=>r.tmin); c.update();
  }catch(e){ alert('å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); console.error(e); }
  finally{ document.body.style.cursor='default'; }
}

function toCSV(rows){
  const header=['date','tmax','tmin','weather_code','weather_label','precipitation'];
  const esc=v=>(v??'').toString().replace(/"/g,'""');
  const lines=[header.join(',')];
  for(const r of rows){ lines.push([esc(r.date),esc(r.tmax),esc(r.tmin),esc(r.weather_code),esc(r.weather_label),esc(r.precipitation)].map(s=>`"${s}"`).join(',')); }
  return '\ufeff'+lines.join('\n');
}
function downloadCSV(){
  if(!lastRows||lastRows.length===0){alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«å–å¾—ã—ã¦ãã ã•ã„ã€‚');return;}
  const area=areaBadge.textContent.replace('ã‚¨ãƒªã‚¢:','').trim()||'area';
  const blob=new Blob([toCSV(lastRows)],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); const ts=new Date().toISOString().slice(0,10);
  a.href=url; a.download=`weather_${area}_${ts}.csv`.replace(/[\s\/\\:*?"<>|]+/g,'_'); document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
}
csvBtn.addEventListener('click',downloadCSV);

document.querySelectorAll('button[data-range]').forEach(b=>b.addEventListener('click',()=>loadRange(parseInt(b.dataset.range,10))));
applyBtn.addEventListener('click',()=>{updateLocBadge(); loadRange(400);});
customBtn.addEventListener('click',()=>{const lat=parseFloat(latEl.value),lon=parseFloat(lonEl.value); if(!startEl.value||!endEl.value){alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');return;} loadCustom(startEl.value,endEl.value,lat,lon);});
showMaxEl.addEventListener('change',()=>{ensureChart(); chart.getDatasetMeta(0).hidden=!showMaxEl.checked; chart.update();});
showMinEl.addEventListener('change',()=>{ensureChart(); chart.getDatasetMeta(1).hidden=!showMinEl.checked; chart.update();});

const FKEY='wt_favs_v1';
function loadFavs(){try{return JSON.parse(localStorage.getItem(FKEY)||'[]');}catch{return[];}}
function saveFavs(a){localStorage.setItem(FKEY,JSON.stringify(a));}
function refreshFavList(){const favs=loadFavs(); favList.innerHTML='<option value="">ãŠæ°—ã«å…¥ã‚Šã‚’é¸æŠ</option>'; for(const f of favs){const o=document.createElement('option'); o.value=JSON.stringify(f); o.textContent=`${f.name} (${f.lat.toFixed(4)},${f.lon.toFixed(4)})`; favList.appendChild(o);}}
favAddBtn.addEventListener('click',()=>{const lat=parseFloat(latEl.value),lon=parseFloat(lonEl.value); let name=(areaBadge.textContent.replace('ã‚¨ãƒªã‚¢:','').trim()||''); name=prompt('ãŠæ°—ã«å…¥ã‚Šåã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šè‡ªå®…ãƒ»è·å ´ãƒ»æ¸‹è°·ãªã©ï¼‰',name||''); if(!name)return; const favs=loadFavs(); favs.push({name,lat,lon,savedAt:new Date().toISOString()}); saveFavs(favs); refreshFavList(); alert('ä¿å­˜ã—ã¾ã—ãŸ');});
favList.addEventListener('change',(e)=>{if(!e.target.value)return; const f=JSON.parse(e.target.value); latEl.value=f.lat.toFixed(4); lonEl.value=f.lon.toFixed(4); updateLocBadge(); areaBadge.textContent=`ã‚¨ãƒªã‚¢: ${f.name}`; applyBtn.click();});
favDel.addEventListener('click',()=>{const v=favList.value; if(!v){alert('å‰Šé™¤ã™ã‚‹ãŠæ°—ã«å…¥ã‚Šã‚’é¸æŠã—ã¦ãã ã•ã„');return;} const f=JSON.parse(v); const favs=loadFavs().filter(x=>!(x.name===f.name&&x.lat===f.lat&&x.lon===f.lon)); saveFavs(favs); refreshFavList();});

const mapModal=document.getElementById('mapModal'), mapBtn=document.getElementById('mapBtn'), closeMap=document.getElementById('closeMap');
const picked=document.getElementById('picked'), usePoint=document.getElementById('usePoint'), tileSel=document.getElementById('tileSel');
let map,marker,pickedLatLng=null,baseLayers={};
function setTile(kind){
  if(!map) return; Object.values(baseLayers).forEach(l=>map.removeLayer(l)); baseLayers={};
  if(kind==='carto'||kind==='voyager'){ const id=kind==='carto'?'light_all':'voyager';
    baseLayers[kind]=L.tileLayer(`https://{s}.basemaps.cartocdn.com/${id}/{z}/{x}/{y}{r}.png`,{subdomains:'abcd',maxZoom:19,attribution:'&copy; OpenStreetMap contributors &copy; CARTO'}).addTo(map);
  }else if(kind==='hot'){ baseLayers[kind]=L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{maxZoom:18,attribution:'&copy; OpenStreetMap contributors, HOT'}).addTo(map); }
}
mapBtn.addEventListener('click',()=>{mapModal.style.display='flex'; setTimeout(()=>{ if(!map){ map=L.map('map',{zoomControl:true,attributionControl:true}).setView([36.2048,138.2529],5); setTile('carto');
  map.on('click',(e)=>{pickedLatLng=e.latlng; if(marker)marker.setLatLng(pickedLatLng); else marker=L.marker(pickedLatLng).addTo(map); picked.textContent=`é¸æŠ: ${pickedLatLng.lat.toFixed(4)}, ${pickedLatLng.lng.toFixed(4)}`;});
  tileSel.addEventListener('change',e=>setTile(e.target.value)); } else { setTimeout(()=>map.invalidateSize(),100); } },0);});
closeMap.addEventListener('click',()=>{mapModal.style.display='none';});
usePoint.addEventListener('click',()=>{if(!pickedLatLng){alert('åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ°ç‚¹ã‚’é¸ã‚“ã§ãã ã•ã„');return;} latEl.value=pickedLatLng.lat.toFixed(4); lonEl.value=pickedLatLng.lng.toFixed(4); updateLocBadge(); mapModal.style.display='none'; applyBtn.click();});

function init(){ updateLocBadge(); refreshFavList(); reverseGeocode(parseFloat(latEl.value),parseFloat(lonEl.value)).then(name=>{areaBadge.textContent=`ã‚¨ãƒªã‚¢: ${name}`;}); loadRange(400); }
init();
</script>
</body>
</html>
